---
title: "Broadband access in lower education and the achievement gap"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r libraries, include = FALSE}
library(tidyverse)
```

```{r data}
# via https://data-nconemap.opendata.arcgis.com/datasets/broadbandindices-bytract-allyears
# all variables are percentages unless otherwise noted in names
broadband <- read.csv("NC_Broadband_Indices.csv")
broadband <- broadband %>% 
  rename(tract = NAMELSAD, fips = FIPS, county = County_Name, `25/3` = Percent_Pop__25_3, 
         `100/20` = Percent_Pop__100_20, fiber = Percent_Pop__Fiber, upload_download_ratio = Up_Down_Ratio, 
         household_density = Hhld__Density, homes_after_2010 = Percent_Age_Home, 
         no_providers = Percent_Pop__No_Prov_, dsl = Percent_Pop__DSL_Only, availability_index = Availability, 
         subscription = Percent_Bbnd__Sub, `18-34` = Percent_Ages_18_34, bachelors = Percent_Bach_, 
         household_with_children = Percent_Hhlds__Children, wfh = Percent_Work_from_home,
         `65+` = Percent_Ages_65_and_over, no_internet = Percent_No_Int__Access, 
         no_computer = Percent_No_Comp__Devices, poverty = Percent_Poverty, disability = Percent_Disability, 
         limited_english = Percent_Lim__English, adoption_index = Adoption, year = YEAR) %>% 
  select(3, 9:32)

# via American Community Survey
nc_race <- read.csv("NC_Race.csv")
broadband <- inner_join(broadband, nc_race) %>% 
  rename(pacific_islander = pacific.islander)

# via U.S. Census Bureau
nc_urban_rural <- read.csv("NC_Urban_Rural.csv")
broadband <- inner_join(broadband, nc_urban_rural)
broadband$pct_urban <- as.numeric(broadband$pct_urban)
broadband$pct_rural <- as.numeric(broadband$pct_rural)

# via https://docs.google.com/spreadsheets/d/1OUny4n_4ssCkCJDtFuHFWJ7jJkO1DfhbERl5_O1oDs0/edit#gid=1261416180
dlmi <- read.csv("NC_Students_with_Internet_Access_at_Home.csv")
dlmi <- dlmi %>% 
  mutate(Fiscal.Year = as.numeric(substring(Fiscal.Year, 1, 4))) %>% 
  rename(year = Fiscal.Year, number = School.Code, name = School.Name, level = SchoolLevel,
         access = X223.....of.Students.with.Home.Internet.Access) %>% 
  select(-Average.DailyMembershipRange, -EconomicallyDisadvantagedRange)
dlmi$access[dlmi$access == "-"] <- NA
dlmi$level[dlmi$level == "-"] <- NA
dlmi <- dlmi %>% 
  arrange(name, year)

dlmi_2019 <- dlmi %>% 
  filter(year == 2019) %>% 
  filter(!is.na(as.numeric(number)))

dlmi_range_2015 <- dlmi %>% 
  filter(year != 2019)

dlmi_range_2019 <- dlmi %>% 
  filter(year == 2019) %>% 
  mutate(access = as.numeric(access)) %>% 
  mutate(access = case_when(access >= 0 & access <= 25 ~ "0-25", access > 25 & access <= 50 ~ "26-50",
                            access > 50 & access <= 75 ~ "51-75", access > 75 & access <= 100 ~ "76-100"))

dlmi <- rbind(dlmi_range_2015, dlmi_range_2019) %>% 
  arrange(name, year)

# via http://apps.schools.nc.gov/ords/f?p=145:221:::NO:::
ncdpi_race <- read.csv("NCDPI_Race.csv")
ncdpi_race <- ncdpi_race %>% 
  mutate(LEA = as.character(LEA), School = as.character(School))
ncdpi_race$LEA[as.numeric(ncdpi_race$LEA) < 100] <- paste0("0", ncdpi_race$LEA)
ncdpi_race <- ncdpi_race %>% 
  mutate(number = paste0(LEA, School)) %>%
  rename(year = Year, district = X____LEA.Name____, name = X___School.Name___,
         indigenous_m = Indian.Male, indigenous_f = Indian.Female, 
         asian_m = Asian.Male, asian_f = Asian.Female,
         hispanic_m = Hispanic.Male, hispanic_f = Hispanic.Female,
         black_m = Black.Male, black_f = Black.Female,
         white_m = White.Male, white_f = White.Female,
         pi_m = Pacific.Island.Male, pi_f = Pacific.Island.Female,
         bi_m = Two.or..More.Male, bi_f = Two.or..More.Female, total = Total) %>% 
  select(-LEA, -School)

# economically disadvantaged & low performance via https://www.dpi.nc.gov/data-reports/school-report-cards/school-report-card-resources-researchers
ncdpi_eds <- read.csv("NCDPI_EDS.csv")
ncdpi_eds <- ncdpi_eds %>% 
  filter(!is.na(as.numeric(agency_code))) %>% 
  rename(number = agency_code) %>% 
  select(-pct_eds_masking)

ncdpi_low_perf <- read.csv("NCDPI_Low_Performance.csv")
ncdpi_low_perf <- ncdpi_low_perf %>% 
  filter(!is.na(as.numeric(agency_code))) %>% 
  rename(number = agency_code, lp = lp_school, rlp = rlp_school) %>% 
  select(year, number, lp, rlp)

dlmi_2019 <- inner_join(dlmi_2019, ncdpi_race) %>% 
  mutate(access = as.numeric(access), total = as.numeric(gsub(",", "", total)))
dlmi_2019 <- inner_join(dlmi_2019, ncdpi_eds)
dlmi_2019 <- inner_join(dlmi_2019, ncdpi_low_perf)
```

```{r summary_statistics}
# check missingness
broadband %>% 
  count(is.na(availability_index))

broadband %>% 
  count(is.na(adoption_index))

broadband %>% 
  count(is.na(no_internet))

broadband %>% 
  count(is.na(no_computer))

broadband %>% 
  filter(is.na(availability_index) | is.na(adoption_index) | is.na(no_internet) | is.na(no_computer))

# calculate summary statistics
broadband %>% 
  filter(!is.na(availability_index) & !is.na(adoption_index) & !is.na(no_internet) & !is.na(no_computer)) %>% 
  summarize(median_availability = median(availability_index), mean_availability = mean(availability_index),
            median_adoption = median(adoption_index), mean_adoption = mean(adoption_index),
            median_no_internet = median(no_internet), mean_no_internet = mean(no_internet),
            median_no_computer = median(no_internet), mean_no_computer = mean(no_internet))

# availability & adoption by county & year
broadband %>% 
  group_by(county, year) %>% 
  filter(!is.na(availability_index) & !is.na(adoption_index) & !is.na(no_internet) & !is.na(no_computer)) %>% 
  summarize(mean_availability = mean(availability_index), mean_adoption = mean(adoption_index),
            mean_no_internet = mean(no_internet), mean_no_computer = mean(no_internet))

# identify schools without observations for all five years
dlmi_inc_schools <- dlmi %>% 
  count(name) %>% 
  filter(n != 5)

# access by year
dlmi %>% 
  filter(!name %in% dlmi_inc_schools$name & !is.na(access)) %>% 
  count(year, access)

dlmi_2019 %>% 
  count(lp)
```

```{r initial_viz}
ggplot(data = broadband, mapping = aes(x = poverty, y = availability_index)) +
  geom_point(mapping = aes(color = pct_urban), alpha = 0.25)

ggplot(data = broadband, mapping = aes(x = poverty, y = adoption_index)) +
  geom_point(mapping = aes(color = pct_urban), alpha = 0.25)

ggplot(data = broadband, mapping = aes(x = poverty, y = no_internet)) +
  geom_point(mapping = aes(color = pct_urban), alpha = 0.25)

ggplot(data = broadband, mapping = aes(x = poverty, y = no_computer)) +
  geom_point(mapping = aes(color = pct_urban), alpha = 0.25)

ggplot(data = broadband, mapping = aes(x = household_with_children, y = availability_index)) +
  geom_point(alpha = 0.25)

ggplot(data = broadband, mapping = aes(x = household_with_children, y = adoption_index)) +
  geom_point(alpha = 0.25)

ggplot(data = broadband, mapping = aes(x = household_with_children, y = no_internet)) +
  geom_point(alpha = 0.25)

ggplot(data = broadband, mapping = aes(x = household_with_children, y = no_computer)) +
  geom_point(alpha = 0.25)

broadband %>% 
  mutate(pct_black = black / total) %>% 
  ggplot(data = ., mapping = aes(x = pct_black, y = availability_index)) +
  geom_point(alpha = 0.25)

broadband %>% 
  mutate(pct_black = black / total) %>% 
  ggplot(data = ., mapping = aes(x = pct_black, y = adoption_index)) +
  geom_point(alpha = 0.25)

broadband %>% 
  mutate(pct_black = black / total) %>% 
  ggplot(data = ., mapping = aes(x = pct_black, y = no_internet)) +
  geom_point(alpha = 0.25)

broadband %>% 
  mutate(pct_black = black / total) %>% 
  ggplot(data = ., mapping = aes(x = pct_black, y = no_computer)) +
  geom_point(alpha = 0.25)

# number of schools in each bucket from 2015 to 2019
dlmi %>% 
  filter(!name %in% dlmi_inc_schools$name) %>% 
  count(year, access) %>% 
  filter(!is.na(access)) %>% 
  ggplot(data = ., mapping = aes(x = year, y = n, fill = access)) +
  geom_bar(position = "dodge", stat = "identity")

dlmi_2019 %>% 
  mutate(pct_black = (black_m + black_f) / total) %>% 
  ggplot(data = ., mapping = aes(x = pct_black, y = access)) +
  geom_point(alpha = 0.25)

ggplot(data = dlmi_2019, mapping = aes(x = pct_eds, y = access, color = lp)) +
  geom_point(alpha = 0.25)

# in 2019-2020 school year, what is the relationship b/w broadband access & achievement?
# which schools have the lowest percentage of broadband access?
# what are the places that have seen the biggest change across years? what has that meant for the school district?
# peer-reviewed academic research on this -> has anybody already developed a methodology on impact of access?
# have grants trickled down to the school? in addition to funding from legislature
```